% This README demonstrates the ability to have a separate glossary for a chapter/appendix

% \newacronym[⟨options⟩]{⟨label⟩}{⟨abbrv⟩}{⟨long⟩}
%\newglossaryentry{⟨label⟩}{type=\acronymtype,
%name={⟨abbrv⟩},
%description={⟨long⟩},
%text={⟨abbrv⟩},
%first={⟨long⟩ (⟨abbrv⟩)},
%plural={⟨abbrv⟩s},
%firstplural={⟨long⟩s (⟨abbrv⟩s)},
%⟨options⟩}



\lstdefinestyle{latexExample}{
language=[LaTeX]{TeX},
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space},
    basicstyle=\small\tt,
    keywordstyle=\color{blue}\sf,
    identifierstyle=\color{magenta},
    commentstyle=\color{cyan},
    backgroundcolor=\color{yellow!15},
    tabsize=2,
    columns=flexible,
}
\lstset{style=latexExample}
\newcommand{\dname}[1]{\textbf{#1}}
\newcommand{\fname}[1]{\texttt{#1}}

\chapter{README and notes about the template}
\label{ch:READMEnotes}

\glsresetall[readme]
This document, written by Gerald Q. Maguire Jr,  describes the thesis template that I have developed for use at \gls{KTH} and provides some background about why it is the way that it is. It is important to note that the template is \textbf{not prescriptive}, as not every thesis will have all the parts the template shows. However, if there is something that you decide to leave out, you should make a conscious decision to do so, and you should consider the impact this may have on your thesis being approved by the examiner.

Fundamental to the design of the template are several key factors:
\begin{itemize}
    \item Helping students be successful in their degree project,
    \item Helping students produce a high-quality thesis, and
    \item Supporting all of the (relevant) phases of the degree project process.
\end{itemize}

Several thousand theses are written each year by \gls{KTH} students. Every approved thesis will be entered into \gls{DiVA} (independent of whether the full text is made available via \gls{DiVA}). Collecting the data necessary for \gls{DiVA} was a major driving force in the design of the template. This data is useful for many of the phases of the degree project, such as announcing the oral presentation.
    
This template is \textbf{not} designed for use by \gls{TIMTM} and \gls{TMMTM} students - as students in these two programs are using a different structure for their reports (there is another template available for them).

\textbf{This document is a work in progress.}

\section{Introduction}
This template evolved (radically) from an earlier thesis template that was widely used at \gls{KTH}. The direction of this evolution was based on the DOCX template developed over many years for use with students for whom I was the examiner and/or supervisor. The suggested structure and contents of the thesis reflect my experience as an examiner for more than 600 degree projects and the experience I have had as a teacher and examiner for the course \textit{II2202 Research Methodology and Scientific Writing}. The template also reflects my interest as a member of KTH's Language Committee in facilitating the parallel use of English and Swedish at \gls{KTH}, as well as supporting other languages. The latter aspect
reflects my experience with double-degree students, who often need to have at least the abstract of their thesis in their home university's language(s). The thesis template also reflects
my experience in entering the metadata for hundreds of theses into \gls{DiVA} and announcing a very large number of degree project seminars.

\Cref{sec:expectedUsers} describes several different groups of users and how the template is relevant to them.

Several major thoughts have influenced the design of this template:
\begin{enumerate}[leftmargin=*, label=\textbf{Thought \arabic*}, ref={Thought \arabic*}]
    \item \label{thought:helpStudent} The template should help a student be successful in their degree project and help them produce a high-quality thesis in conjunction with their degree project.
    
    \item \label{thought:process} The template should help support all of the (relevant) phases of the degree project process.
    
    \item \label{thought:reducingDataEntry} Redundant data entry should be minimized to increase consistency.
    
    \item \label{thought:volume} There are several thousand theses written each year at \gls{KTH}. Theses are the second most common type of publication at \gls{KTH}.
    
    \item \label{thought:inDiVA} Every approved thesis will have at least its metadata entered into \gls{DiVA}. \gls{DiVA} features multi-language support for title, subtitle, abstract, and keywords.
\end{enumerate}

\section{Deliminations}

This template is \textbf{not} designed for use by \gls{TIMTM} and Media Management \gls{TMMTM} students - as students in these two programs are using a different structure for their reports (there is another template available for them).

Additionally, I have been told by one of my colleagues in applied mathematics that theses in this area generally do not follow the \gls{IMRAD} structure.

Some parts of the template are conditional based on the value of a switch: \texttt{\textbackslash ifinswedish}. The idea is to easily have a single template that supports theses written in English or Swedish. However, in many places, the conditional has not been used but could be. Examples of this include the Swedish names for chapters and sections. Generally, this information is in a note after the English chapter or section name. More complete implementation of the use of this condition remains as future work.

The template does not fully support the G5 paper format. In particular, the \gls{KTH} cover (produced with \texttt{\textbackslash kthcover)} and back cover (produced with \texttt{\textbackslash kthbackcover)}) have only been adapted for A4 paper. Support for G5 paper remains as future work.

The handling of the subject area (Swedish: \foreignlanguage{swedish}{Område för examensarbete}) is currently incomplete and remains as future work. Personally, I'm still struggling to understand the rules and how one knows what the correct values are (especially for cases of \first dual degrees and \Second combinations of technical subjects and education degrees).

\section{Structure of the files for the template}
\Cref{tab:file_structure} shows the structure of the files for the template. These files are generally taken from an existing Overleaf project, a ZIP file, or a github.

One hope is that by automatically extracting information from various sources, this information is more likely to be \textit{correct} and \textit{consistent} (supporting \ref{thought:reducingDataEntry}). This approach has been used to generate two of the files used for the template. These files are:
\begin{enumerate}
    \item The file \fname{custom\_configuration.tex} contains macros and values for configuring a project. These values are generally expected to be known at the start of the project, \eg author(s), supervisor(s). examiner, course code for the degree project program code, \etc. While this file can be manually edited, it was designed to be generated by a program that I have written that extracts most of the data from the Canvas course being used in conjunction with the degree project. One of the goals of using such a program is to extract data from Canvas automatically, the \gls{KTH} profile \gls{API}, \gls{KOPPS}, and other sources. The macros for defining this information are described in Sections \ref{sec:authorMacros}, \ref{sec:supervisorMacros}, and \ref{sec:examinerMacros} - for authors, supervisors, and examiner (respectively).

    \item The file \texttt{schools\_and\_programs.ins} contains the English and Swedish names of schools and programs. A program extracted this information from \gls{KOPPS}.
\end{enumerate}

We will assume that these files have been generated by someone. Later, we will examine who this someone might be for each of these files.

\begin{table}[!ht]
    \caption{Structure of files for the template}
    \label{tab:file_structure}
\resizebox{\columnwidth}{!}{%
    \begin{tabular}{l l p{4cm}<{\raggedright}}
%\textbf{Top level} & \textbf{2\textsuperscript{nd} level} & \textbf{Description} \\
\hline
\dname{bibstyle} & \multicolumn{2}{c}{\textbf{directory containing files related to the style of the bibliography}} \\
{} & \fname{myIEEEtran.bst} & a bibtex style file  \\
\hline
\dname{figures} & \multicolumn{2}{c}{\textbf{directory containing files for figures}} \\
\hline
\dname{kth} & \multicolumn{2}{c}{\textbf{directory containing various files for the kththesis class}}  \\
& \fname{kth-commands.tex} & definition of commands \\
& \fname{kth-fonts.tex} & fonts for the template \\
& \fname{kth-layout.tex} & the graphical layout \\
& \fname{kth-packages.tex} & the packages used in the template \\
& \fname{kth-sanity-check.tex} & some code to do sanity checking \\
\hline
\dname{lib} & \multicolumn{2}{c}{\textbf{directory containing various library files}}  \\
& \fname{acronyms.tex} & a place to define the acronyms that will or might be used \\
& \fname{defines.tex} & some generally useful defines \\
& \fname{includes-after-hyperref.tex} & a special include file for packages that have to be included \textbf{after} the hyperref package \\
& \fname{includes.tex} & a centralized place to include packages that might be useful \\
& \fname{kthcolors.tex} & defines a number of colors from the \gls{KTH} palette \\
& \fname{pdf\_related\_includes.tex} & includes to be able to add the title and other information to the PDF file \\
& \fname{schools\_and\_programs.ins} & English and Swedish names of schools and the programs \\
\hline
\fname{custom\_configuration.tex} & & macros and values for configuring a project\\
\fname{examplethesis.tex} & & an example of the thesis itself \\
\fname{kth\_logo.png} & & the \gls{KTH} logo for use on the cover \\
\fname{KTH\_ROYAL\_INSTITUTE\_OF\_TECHNOLOGY\_logotype.png} & & \gls{KTH} logotype for use on the English language cover \\
\fname{kththesis.cls} & & the kththesis class file \\
\fname{README\_notes.tex} & & these notes \\
\fname{references.bib} & & references that may be cited in the thesis \\
\end{tabular}
}  % End of resizebox

\end{table}
%\FloatBarrier
\clearpage


\section{Expected users and their differences}
\label{sec:expectedUsers}
This template is relevant to several different sets of users:
\begin{enumerate}[leftmargin=*,label=\textbf{Users \arabic*}, ref={Users \arabic*}]
    \item \label{users:authors} Author or Authors (see \Cref{sec:authors}),
    \item \label{users:others} Those working together with the author(s) during the degree project process (see \Cref{sec:examinerAdvisorsOpponent}),
    \item \label{users:admins} Administrative staff working with the document after it has been approved by the examiner (see \Cref{sec:adminStaff}), and
    \item \label{users:readers} The (hopefully) many (human) readers of the final document (see \Cref{sec:readers}).
    \item \label{users:searchEngines} The (hopefully) many computers reading the metadata and the full text of the final document (see \Cref{sec:searchEngines}).
    \item \label{users:maintainer} Those who are maintaining or updating this template (see \Cref{sec:maintainer}).
\end{enumerate}

Each of these different sets of users has different needs and perspectives. The following subsections describe these needs and perspectives.

For information for authors, see \Cref{{ch:READMEauthor}} - located in the file \texttt{README\_author.tex}.

\section[Those working in parallel with the authors(s) during the degree project]{Those working in parallel with the\\authors(s) during the degree project}
\label{sec:examinerAdvisorsOpponent}
Those working together with the author(s) during the degree project process include the examiner, supervisor(s), and the opponent(s).

\subsection{Supervisor}
\label{sec:supervisorMacros}
If a degree project is done in industry, there is generally an industrial supervisor in addition to the academic supervisor(s). The template supports up to 5 supervisors (typically an academic supervisor, an industrial supervisor, and sometimes an additional academic or industrial supervisor). The choice of up to five reflects my experience, observation of prior theses in \gls{DiVA}, and a request by a student with four supervisors. Note that there is expected to be at least one supervisor. The supervisors are enumerated as A, B, C, D, and E. For each of A, B, C, D, and E as appropriate, replace the "X" in the following macros:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash supervisorXsLastname\{\}}] the last name of the supervisor
\item [\texttt{\textbackslash supervisorXsFirstname\{\}}] the first name of the supervisor
\item [\texttt{\textbackslash supervisorXsEmail\{\}}] e-mail address of the supervisor
\end{description}

If the supervisor is from within \gls{KTH}, then add their KTHID, School, and Department info:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash supervisorXsKTHID\{\}}] the supervisor's kthid 
\item [\texttt{\textbackslash supervisorXsSchool\{\}}] the school of the supervisor
\item [\texttt{\textbackslash supervisorXsDepartment\{\}}] the department of the supervisor
\end{description}

If the supervisor is from outside of \gls{KTH}, then add their organization with:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash supervisorXsOrganization\{\}}] the supervisor's organization
\end{description}

\subsection{Examiner}
\label{sec:examinerMacros}
I assume that there is only a single examiner for a given thesis\footnote{Statistically, there are very few theses with multiple examiners, and this generally occurs for students either in a double degree program or when there are two students in a 1\textsuperscript{st} cycle degree project from different schools, then there might be one examiner for each student. As the case of more than one examiner occurs very infrequently, I have left it for future work. The pseudo-JSON structure is set up to handle multiple examiners, but additional macros would be needed in a similar fashion as used for multiple supervisors, and this metadata would have to be conditionally added where appropriate.}. For this examiner, the relevant macros are:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash examinersLastname\{\}}] the last name of the examiner
\item [\texttt{\textbackslash examinersFirstname\{\}}] the first name of the examiner
\item [\texttt{\textbackslash examinersEmail\{\}}] e-mail address of the examiner
\end{description}

If the examiner is from within \gls{KTH}, then add their KTHID, School, and Department info:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash examinersKTHID\{\}}] the examiner's kthid 
\item [\texttt{\textbackslash examinersSchool\{\}}] the school of the examiner
\item [\texttt{\textbackslash examinersDepartment\{\}}] the department of the examiner
\end{description}

If the examiner is from outside of \gls{KTH}, then add their organization with:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash examinersOrganization\{\}}] the examiner's organization
\end{description}


I assume that someone (such as the examiner) will generate the file:\linebreak[4] \fname{custom\_configuration.tex}. This assumption is based upon the fact that the examiner knows who the student or students are who will be working on a given degree project, who the supervisor or supervisors are, what program the student is in, course code, \ldots\,. Ideally, this file should be generated automatically by some computer program so that each student or pair of students in a group gets a customized template automatically via the Canvas course. However, currently, the file is generated using a command line program (\texttt{create\_customized\_JSON\_file.py}) to generate a \gls{JSON} file. Subsequently, a separate program (\texttt{customize\_LaTeX\_project.py}) takes this \gls{JSON} data and creates the appropriate \LaTeX\ commands and inserts this information into the file and then inserts this file into a ZIP file, either replacing or augmenting the \fname{custom\_configuration.tex} within this ZIP file (if one exists). There is an option for this second program \texttt{--initialize} that causes the program to simply replace the file rather than appending the new information to the end of the file.

The above programs are available from \url{https://github.com/gqmaguirejr/E-learning}. The README file for this GitHub contains information about how to run the programs, their options, and gives examples.

\subsection{Opponent(s) and oral presentation}
\label{sec:opponentMacros}
Unlike the supervisors and examiner, the macros related to the opponent and oral presentation are in the \fname{examplethesis.tex} file.
The macro for the opponent(s) is: 
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash secondAuthorsFirstname\{\}}}]
\item [\texttt{\textbackslash opponentsNames\{\}}] the names (in normal name order) of the opponent or opponents
\end{description}
When there are multiple opponents, separate their names with '\textbackslash \&'; for example, A. B. Normal \textbackslash \& A. X. E. Normalè.

For the oral presentation, the following macros are filled in once the examiner has scheduled your oral presentation:
\begin{description}[leftmargin=!, labelwidth =\widthof{\texttt{\textbackslash presentationDateAndTimeISO\{\}}}]
\item [\texttt{\textbackslash presentationDateAndTimeISO\{\}}] date and time of the presentation is ISO format, for example: 2022-03-15 13:00
\item [\texttt{\textbackslash presentationLanguage\{\}}] three letter abbreviation for the language of the presentation according to three letter ISO 639-2 Code – specifically the "B" (bibliographic) variant of these codes (note that this is the same language code used in DiVA), generally eng or swe
\item [\texttt{\textbackslash presentationRoom\{\}}] a room name and/or\hspace*{\fill}\linebreak[4] ``via Zoom \url{https://kth-se.zoom.us/j/ddddddddddd}''
\item [\texttt{\textbackslash presentationAddress\{\}}] location of the room, for\linebreak[4] example: Isafjordsgatan 22 \linebreak[4](Kistagången 16)
\item [\texttt{\textbackslash presentationCity\{\}}] city where the presentation \linebreak[4]occurs, generally: Stockholm
\end{description}


\section{Administrative staff}
\label{sec:adminStaff}

Once a thesis is approved by the examiner we need to add the TRITA number. The TRITA number is assigned by the student affairs office of the school from an annual series of numbers.

\subsection{What is a TRITA number and why does each approved thesis get assigned one?}

TRITA stands for Transactions for the Royal Institute of Technology, with the letter 'A' appended to it. The TRITA definition is the 1971 report, ``\foreignlanguage{swedish}{Mall för publikationsserier vid Kungl. Tekniska högskolan i Stockholm}'', TRITA-LIB-1001, \url{http://urn.kb.se/resolve?urn=urn:nbn:se:kth:diva-127656}.

The format for TRITA numbers for degree projects is TRITA-$\langle$school acronym$\rangle$-EX-YYYY:nnnn, where nnnn is a sequential number starting from 1 each year with the numbers assigned in chronological order to approved theses (``\foreignlanguage{swedish}{numren delas ut kronologiskt först när examinatorn godkänt arbetet.}'' - according to one of KTH's archivists). Note that the list of assigned TRITA numbers is archived each year\footnote{It seems that this archiving is done twice a year.}. The year, YYYY, is based on the year that the thesis was \emph{approved}.

The TRITA number value can be set with a macro that takes two arguments: series and year:number as shown below:
\begin{lstlisting}
% for entering the TRITA number for a thesis
\trita{TRITA-XXX-EX}{2022:00}  
\end{lstlisting}

\subsection{Where does the TRITA number go?}
The TRITA number will appear on the back cover of the thesis. It is also stored as part of the metadata entered into \gls{DiVA}.

\subsection{What does this mean in practice?}
Currently, at School of XXX\footnote{Name replaced to neutralize the template.} the TRITA number is only assigned to the thesis when the examiner has approved the thesis and submitted the PDF of the approved thesis (with cover) to the student affairs office. Of course, this does not make much sense because the back cover is already on the thesis! This means that someone in the student affairs office must either \first edit the sequential number part of the TRITA number (using some PDF tool) or \Second they need to make a new back cover and replace the existing back cover. A better solution would be to inform the examiner of the TRITA number and the examiner can see that this number is inserted into the macro shown above and this can enable the number to appear on the back cover and as an added bonus be included in the metadata for \gls{DiVA}.

Note that it is expected that in 2023, this process will change -- thus the assignment of the TRITA number and the application of the back cover would be done by the student affairs office (as only they have the relevant information)\footnote{Note to maintainers: This means that the back cover can be removed from this template.}.

\subsection{Entering the metadata into DiVA}
If a thesis has used this template the ``For DIVA'' page contains the metadata for \gls{DiVA} and an administrator can cut and paste this data into \gls{DiVA}. Alternatively, this metadata can be extracted with a program from the PDF file to produce a \gls{JSON} file that can subsequently be used to create a MODS file for import into \gls{DiVA}. The \LaTeX\ compiler can in many cases produce a file called ``fordiva.json'' that contains the metadata.

The programs that can be used to extract data and to take a \gls{JSON} file and create a MODS file are available from \url{https://github.com/gqmaguirejr/E-learning}.

Note that the import of the MODS file does \textbf{not import the collaboration data}, even though this is in the file. This is a limitation of the \gls{DiVA} import function. Therefore, this information has to be manually entered along with uploading of the PDF file itself.

\section{(Human) Readers of the thesis}
\label{sec:readers}
Some theses have very few downloads from \gls{DiVA}, while some have had hundreds of thousands of downloads. Therefore, you should remember that you have a wide range of human readers of your thesis. The readers include other students looking for information related to their own thesis or because they are interested in the future work that you have suggested to work on for their own degree project. Additionally, researchers who are looking for your results may find your thesis relevant to them. In many cases, companies will look at theses for ideas about what the state of the art is - in several cases, theses have been important as ``prior art'' and this invalidated patents that had been issued if the patent was submitted after the thesis became public (hence it pays to get theses public as soon as possible). Other human readers are the \foreignlanguage{swedish}{UKÄ} review teams that examine the degree programs offered at \gls{KTH}. Finally, as \gls{KTH} is a public agency, it is important that the general public know what is done at \gls{KTH}\footnote{This is an important part of the Swedish \foreignlanguage{swedish}{Offentlighetsprincipen}.}.

\subsection{Machines reading the metadata or full text of the thesis}
\label{sec:searchEngines}
The file \fname{pdf\_related\_includes.tex} contains \LaTeX\ code that stores the title, author(s), and keyword information into the PDF document in such a way that if you ask for the properties of the PDF file you will get this data. This information makes it easier for machines to get this information from the PDF file. 

Additionally, many search engines (such as Google's search engine) mine \gls{DiVA} for the metadata and if the full text of the thesis is published via \gls{DiVA} then they also process the full text of the thesis. The result is that search engines can find the content in these theses.  This is likely to increase the probability that someone will download your thesis if they think it is relevant to them -- increasing the number of your human readers (see \Cref{sec:readers}).

\subsection{Template author and maintainers}
\label{sec:maintainer}

\gls{KTH} periodically changes the cover design for theses, introduces new programs of study, eliminates programs of study, reorganizes administratively,
and faculty move between schools, departments, and divisions. It can be expected that this template will need to evolve with these changes.

For example, if there is a change in schools or programs then there needs to be changes made to the file \texttt{schools\_and\_programs.ins}. While the current file was extracted from \gls{KOPPS}, the program that does this will need to be replaced because further development of \gls{KOPPS} has been terminated by KTH's central IT unit which plans to transition all of this information to \gls{LADOK}.

As another example, on 13 December 2021 there was a change in the \gls{KTH} cover for 1\textsuperscript{st} and 2\textsuperscript{nd} theses, and the cover generator web service was shutdown. The initial draft version of the cover used a proprietary font (TheSans B4 SemiLight and TheSans B6 SemiBold). The version that was publicly introduced uses another proprietary font (Arial) and officially only existed as a DOCX file for a thesis in Swedish. The result is that I had to make my own version in \LaTeX\  to try to emulate the DOCX cover. This lead to a lot of effort, but one can get a reasonable cover with the correct font as described in \Cref{sec:latexEngine}.



\section{More about Abstracts}
\label{sec:MoreAboutAbstracts}

In addition to abstracts of the form shown in the template, there is another form of abstracts, called structured abstracts. These are described in \Cref{sec:StructuredAbstracts}. Some automated checking of abstracts has been added to the template, see \Cref{sec:AbstractChecking}.

\Needspace*{12\baselineskip}
\subsection{Structured abstracts}
\label{sec:StructuredAbstracts}
In some fields, structured abstracts are commonly used. These typically have the following parts:
\begin{verbatim}
Background/Objectives
    <text>
Method
    <text>
Results
    <text>
Conclusions
    <text>
\end{verbatim}

Such structured abstracts are typically longer (in word count) than typical abstracts. For an example of such a structured abstract, see \cite{menendez-aller_humor_2020}.
The document is available in both English (\textit{Humor as a protective factor against anxiety and depression}) and Spanish (\textit{\foreignlanguage{spanish}{El humor como factor protector de la ansiedad y la depresión}}) via \url{https://pmc.ncbi.nlm.nih.gov/articles/PMC6994741/}.

\subsection{Automated checking of some properties of abstracts}
\label{sec:AbstractChecking}
To avoid common mistakes, the template now checks the contents of the abstracts and outputs warnings if the author puts a citation or cross-reference into the abstract.

The method of checking was inspired by the code used in the ACM Conference Proceedings templates to give a warning if the user uses a \textbackslash vspace command or redefines \textbackslash baselinestretch, see \Cref{lst:ACMTemplateSnippet}. To check the abstract, a pair of functions was introduced to save and restore commands, as was done in the package \texttt{phfnote}, see \Cref{lst:phfnoteSnippet}.

\Needspace*{19\baselineskip}
\begin{lstlisting}[style=latexExampleForAuthors, caption={Code snippet from ACM Conference Proceedings template}, label=lst:ACMTemplateSnippet]
\let\@vspace@orig=\@vspace
\let\@vspacer@orig=\@vspacer
\apptocmd{\@vspace}{\ClassWarning{\@classname}{\string\vspace\space should
    only be used to provide space above/below surrounding
    objects}}{}{}
\apptocmd{\@vspacer}{\ClassWarning{\@classname}{\string\vspace\space should
    only be used to provide space above/below surrounding
    objects}}{}{}
\let\@vspace@acm=\@vspace
\let\@vspacer@acm=\@vspacer
\let\ACM@origbaselinestretch\baselinestretch
\AtEndDocument{\ifx\baselinestretch\ACM@origbaselinestretch\else
  \ClassError{\@classname}{An attempt to redefine
    \string\baselinestretch\space detected.  Please do not do this for
    ACM submissions!}\fi}
\end{lstlisting}


\Needspace*{30\baselineskip}
\begin{lstlisting}[style=latexExampleForAuthors, caption={Code snippet from phfnote package}, label=lst:phfnoteSnippet]
%% Macros from the package phfnote
% \phfnoteSaveDefs{〈identifier〉}{〈list of macro names〉} saves the current definitions of the given list of macros under the identifier. The list of macros is specified as a comma-separated list of macro names.

\def\phfnoteSaveDefs#1#2{%
  \csgdef{phfnote@restoredefs@#1}{}%
  \def\@tmpa{#2}%
  \@for\next:=\@tmpa\do{%
    \global\csletcs{phfnote@restoredefs@#1@\next}{\next}%
    \expandafter\xappto\csname phfnote@restoredefs@#1\endcsname{%
      \noexpand\csletcs{\next}{phfnote@restoredefs@#1@\next}%
    }%
  }%
}

% \phfnoteRestoreDef{〈identifier〉} - restores the saved macros
\def\phfnoteRestoreDefs#1{%
  \ifcsname phfnote@restoredefs@#1\endcsname%
    \csname phfnote@restoredefs@#1\endcsname%
  \else%
    \PackageError{phfnote}{\string\phfnoteRestoreDefs: no such
      definitions stored (#1)}{}
  \fi%
}
\end{lstlisting}

Given these two new macros, we use hooks (provided by the \texttt{etoolbox} package) to save the definition of \textbackslash cite before the abstract and restore it afterwards -- as well as to redefine \textbackslash cite to produce a warning if used within the abstract. Note that in the PDF output, there will be {\NotoSansFont \textcolor{red}{⁉cite⁉}} at the place (in the PDF) where the \textbackslash cite was - to draw the user's attention to the error. The same mechanism is used for several other macros. The code for these hooks is shown in \Cref{lst:HooksSnippet}.
\Needspace*{18\baselineskip}
\begin{lstlisting}[style=latexExampleForAuthors, caption={Hooks to save an restore the cite and ref definitions before and after the abstract environment}, label=lst:HooksSnippet]
\BeforeBeginEnvironment{abstract}{\phfnoteSaveDefs{origcmds}{cite,ref,Cref,cref}%
\renewcommand{\cite}[1]{{\NotoSansFont \textcolor{red}{⁉\uuline{cite}⁉}}\PackageWarning{kththesis}{attempt to use cite command in an abstract}}%
\renewcommand{\ref}[1]{{\NotoSansFont \textcolor{red}{⁉\uuline{ref}⁉}}\PackageWarning{kththesis}{attempt to use ref command in an abstract}}%
\renewcommand{\Cref}[1]{{\NotoSansFont \textcolor{red}{⁉\uuline{Cref}⁉}}\PackageWarning{kththesis}{attempt to use Cref command in an abstract}}%
\renewcommand{\cref}[1]{{\NotoSansFont \textcolor{red}{⁉\uuline{cref}⁉}}\PackageWarning{kththesis}{attempt to use cref command in an abstract}}%
}

\AfterEndEnvironment{abstract}{\phfnoteRestoreDefs{origcmds}}
\end{lstlisting}

The hooks shown in \Cref{lst:HooksSnippet} produce a warning message that provides the page number where the \textbackslash cite was used in an abstract (see \Cref{fig:sec:cycle3CiteWarning}). This code could be expanded to handle other undesirable commands in an abstract.


\begin{figure}[!ht]
  \begin{center}
    \includegraphics[width=0.99\textwidth]{README_notes/cite_warning_in_abstract.png}
  \end{center}
  \caption{Example of a warning for use of a citation in an abstract)}
  \label{fig:sec:cycle3CiteWarning}
\end{figure}

The combination of two red Exclamation Question Marks ({\NotoSansFont ⁉}, unicode U+2049) with the command between them (double underlined) was selected as: \first this string is unlikely in the user's text, \Second it was colored red to make it highly visible, and \third the offending command is double underlined to help make it visible (even to those who cannot see the color red). While this combination of characters is sometimes turned into an Interrobang glyph ({\NotoSansFont ‽}, unicode U+203D), I have chosen to use the Exclamation Question Mark glyph as I found the Interrobang too subtle visually. Additionally, when using struck-through or struck-out characters rather than the double underline, it was too hard to read the name of the command. While the PDF does not include the arguments to the \textbackslash cite or \textbackslash ref command - these are in the source \LaTeX\ .

\subsection{Tables and images in abstracts}
\label{sec:TablesAndImagesInAbstracts}
\warningExpl{This template and the tools that I have written to help enter the metadata into DiVA do \textbf{not} support tables and figures in abstracts.}

As an abstract in DiVA can contain HTML code, it is technically possible to make tables and include figures in a DiVA abstract. The problems are \first that I do not know a general means of transforming a table from LaTeX to HTML, and \Second I do not know of a good way of passing the image (or images) that might be in a LaTeX abstract (via tools) to DiVA. The second problem might be addressed by attaching the image files to the PDF and adding code to the generated HTML to refer to these images. One problem with this is that the images would probably need to be uploaded as supplemental/supporting material, and then there would need to be some tool to update the abstract to refer to this uploaded file.

In a recent correction that I suggested for a thesis abstract in DiVA, I manually created the table in HTML to match the table that was in the abstract in the printed thesis.
\warningExpl{The DiVA administrator who entered the thesis into DiVA had not put \emph{any} of the abstract in, but simply put "See file" in the abstract field!}

\subsection{Graphical or visual abstracts}
\label{sec:GraphicalAbstracts}

\gls{KI} has an excellent page about graphical abstracts, see \href{https://kib.ki.se/en/visualise-present/visualising-data/graphical-abstracts}{Graphical abstracts}. At present, this template does \textbf{not} provide any special support for graphical abstracts. One can use the usual mechanisms to include a figure in the abstract; however, see Appendix \ref{sec:TablesAndImagesInAbstracts}.

\warningExpl{I am unsure \first how to deal with such figures with respect to facilitating their inclusion in DiVA (Could it be uploaded separately as supplemental material?), and \Second it is unclear to me whether this graphical abstract would be placed before or after the keywords in the LaTeX file. This will require some further evaluation.}

\engExpl{Recently, I helped create such a graphical abstract (for a journal paper) using \texttt{tikz}. This might have some advantages in terms of accessibility if the \texttt{tikz} source code were available to a (screen) reader.}

\section{Cover illustration}
\label{sec:coverIllustration}
Some theses feature an optional cover illustration. Although I have not gotten an answer from the KTH communications unit about the specifications of the cover illustration, I have tried to infer something suitable from a DOCX file.
\warningExpl{Due to the lack of a specification for the cover illustration, one should treat this feature of my template as an experimental feature that will be subject to change. Use at your own risk.}

Two macros are introduced to make this process simpler, see \Cref{lst:SettingCoverIllustration}. The first (\texttt{\textbackslash coverIllustration}) provides the filename of the illustration to be used. The template includes an image1.png file. This blue rectangular image was taken from the DOCX template. The author should replace this file with the illustration that they want to use.

\textbf{NB} There are some constraints about what you can put on the cover. If in doubt, query KTH's \href{https://intra.kth.se/en/styrning/kths-organisation/verksamhetsstod/kommunikationsavdelningen-1.872391}{Communications Department (COM)}.

The second macro (\texttt{\textbackslash coverIllustrationCredit}) enables the author to acknowledge the creator of the illustration. Here, we will assume that the author has the creator's permission to include the illustration on the cover of their thesis. If the author has created their own illustration, then they do not need to specify any credit, as it is implicitly the work of the author.

\textbf{NB} The author may have to manually adjust the height and width options to the \texttt{\textbackslash includegraphics} command in the \texttt{kththesis.cls} file to get the results that they want. If you make the figure too large, it will appear on a second page and \textbf{not} on the cover. If this occurs, you need to reduce the height of the illustration.

\begin{lstlisting}[style=latexExampleForAuthors, caption={Configuring a cover illustration}, label=lst:SettingCoverIllustration]
% It is possible to have a cover illustration
\coverIllustration{figures/image1.png}
% if so, the author might acknowledge this or give the copyright information for it with:
\coverIllustrationCredit{A. B. Normal}
\end{lstlisting}

\section{While writing}
As was noted in \Cref{sec:authors}, the thesis template contains lots of examples, notes, and comments. One method to provide additional information is the use of \textbackslash todo. Several different types of \texttt{todo} notes have been used in the thesis. These are described in \Cref{sec:todonotes}.

\subsection{Conventions for todo notes}
\label{sec:todonotes}
The example thesis text includes extensive comments, directions, and warnings. These follow the form shown below:
\begin{lstlisting}
\generalExpl{Comments/directions/... in English}
\sweExpl{Text på svenska}
\engExpl{English descriptions about formatting}
\warningExpl{warning}  
\end{lstlisting}
and appear as:
\generalExpl{Comments/directions/... in English}
\sweExpl{Text på svenska}
\engExpl{English descriptions about formatting}
\warningExpl{warning}

Each of the above is a macro, so as usual in \LaTeX\ you can redefine it - even defining it to produce nothing! Several previous students have placed these re-definitions in the \fname{custom\_configuration.tex} file.

\subsection{Turning on and off the README\_notes}
As the various README notes are targeted at different readers, you may or not want to see them. It is very easy to turn them on or off by adding or removing a percent ('\%') character before the relevant \textbackslash begin\{comment\} and \textbackslash end\{comment\} comments around each set of notes.

For example, if you are a student writing a thesis, I suggest turning off everything except for the \fname{README\_author.tex} and \fname{README\_notes.tex} sets of notes. However, I would suggest keeping the other README files around (at least for a little while) as a source of examples of how to do things. Despite having spent a very large number of hours working on the template and drafts of students' theses, I find some of the README files very helpful as a reminder of how to do things.

\subsection{Removing the README\_notes}
At some point you will no longer want this README information. You can remove it by removing the line
\textbackslash include\{README\_notes/README\_notes\} -- from the \fname{examplethesis.tex} file. If you have removed the other README* files from the \dname{README\_notes} directory, you can then remove the \dname{README\_notes} directory.

\subsection{Removing the README\_notes}
At some point, you will no longer want this README information. You can remove it by removing the line
\textbackslash include\{README\_notes/README\_notes\} -- from the \fname{examplethesis.tex} file. If you have removed the other README* files from the \dname{README\_notes} directory, you can then remove the \dname{README\_notes} directory.

\subsection{Removing unused fonts}
This version of the template may also have some font information, in the form of Opentype Font files (with the extension ``.otf'') and TrueType Font font files (with the extension ``.ttf''). If you are not using these fonts (and no longer are using any of the README files), then you can delete these font files.

%\printglossary[type=readme,toctitle={Acronyms used in README notes}]


